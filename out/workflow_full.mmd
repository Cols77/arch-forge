flowchart TD
  Start["Start / resume run\n(load CAM + rules + policy + overrides + state)"]

  subgraph Origins["Delta origins (proposals only)"]
    Chat["User chat prompt"] --> CandAD
    Edit["Diagram edits (typed events)"] --> CandAD
    Analysis["Automated analysis\n(docs ingest + code grounding)"] --> CandAD
    Bootstrap["Bootstrap agent\n(nodes-only proposal)"] --> CandAD
    TreeSitter["Tree-sitter analysis\n(edges-only proposal)"] --> CandAD
  end

  Start --> CandAD["Candidate Architecture Delta (AD)"]

  CandAD --> Validate["Validate AD\n(structure + archetype rules + CAM invariants + rule DSL + policy + overrides)"]

  Validate -->|needs_clarification| Clarify["Ask blocking questions\nand revise AD"] --> CandAD
  Validate -->|invalid| Repair["Revise AD\nand re-validate"] --> CandAD

  Validate -->|valid| Approval["Approval gate\n(Apply delta)"]
  Approval -->|approved| Apply["Apply AD to CAM\n(append cam/deltas/*; update cam/cam.json)"]
  Approval -->|rejected| Rejected["Record rejection\n(no CAM change)"]

  Apply --> Views["Compile diagrams from CAM only\n(Mermaid/DOT views; non-authoritative)"]

  Apply --> ExecPlan["Derive execution plan\n(schema-validated; CAM mutation forbidden)"]
  ExecPlan -->|user approves execution| Execute["Execution agents modify code only"]
  Execute --> Evidence["Post-exec grounding\n+ evidence capture"]
  Evidence --> StatusAD["Follow-up AD\n(status/lifecycle transitions)"] --> Validate

  Apply --> Workflow["Validate workflow slice\n(record validated workflows)"]
  Workflow -->|validated workflows below target: 10| Loop["Continue (more proposals)"] --> CandAD
  Workflow -->|validated workflows meet or exceed target: 10| Stop["Stop exploration\n(policy-enforced termination)"]
